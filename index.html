<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Сайт для чуханья Гоги</title>
  <style>
    @font-face {
      font-family: 'Abaddon';
      src: url('./fonts/Abaddon.ttf') format('truetype');
    }
    body {
      margin: 0; background: #0a0a0a; color: #fff; font-family: sans-serif;
    }
    header { text-align: center; padding: 20px; font-family: Abaddon, sans-serif; font-size: 48px; }
    main { display: flex; justify-content: center; align-items: center; gap: 20px; padding: 20px; }
    img { max-width: 600px; width: 100%; cursor: pointer; border-radius: 12px; }
    aside { font-size: 24px; }
    .value { font-size: 48px; color: #b3ff57; }
    .hint { font-size: 14px; color: #aaa; }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDjM1XK6AhEv_goV5ITHjmfYyp1WZV0pOM",
      authDomain: "chux-d64af.firebaseapp.com",
      databaseURL: "https://chux-d64af-default-rtdb.firebaseio.com",
      projectId: "chux-d64af",
      storageBucket: "chux-d64af.appspot.com",
      messagingSenderId: "851414160802",
      appId: "1:851414160802:web:167e118a83b210b2694efb",
      measurementId: "G-H3YQE42M5T"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    document.addEventListener('DOMContentLoaded', () => {
      const img = document.getElementById('main-photo');
      const valueNode = document.getElementById('counter-value');
      const statusNode = document.getElementById('status');

      function setStatus(msg) {
        statusNode.textContent = msg;
        console.log(msg);
      }

      const counterRef = ref(db, 'gogaCounter');
      onValue(counterRef, (snap) => {
        if (snap.exists()) {
          valueNode.textContent = snap.val();
          setStatus('Подключено');
        } else {
          valueNode.textContent = 0;
          setStatus('Узел пуст, создастся при первом клике');
        }
      }, (err) => {
        setStatus('Ошибка чтения: ' + err.message);
      });

      signInAnonymously(auth).catch((e) => {
        setStatus('Ошибка входа: ' + e.message);
      });

      onAuthStateChanged(auth, (user) => {
        if (user) {
          setStatus('Готово: нажимай на фото');
        }
      });

      const sounds = [ './sounds/1.mp3', './sounds/2.mp3', './sounds/3.mp3' ];
      function playRandomSound() {
        if (!sounds.length) return;
        const url = sounds[Math.floor(Math.random() * sounds.length)];
        const audio = new Audio(url);
        audio.play().catch(e => console.warn('Не удалось воспроизвести звук:', e));
      }

      img.addEventListener('click', async () => {
        playRandomSound();
        try {
          await runTransaction(counterRef, (current) => {
            return (Number(current) || 0) + 1;
          });
        } catch (e) {
          setStatus('Ошибка записи: ' + e.message);
        }
      });
    });
  </script>
</head>
<body>
  <header>сайт для чуханья гоги</header>
  <main>
    <img id="main-photo" src="./images/main.jpg" alt="Гога" />
    <aside>
      <div>почухан раз:</div>
      <div id="counter-value" class="value">0</div>
      <div id="status" class="hint">Подключаюсь…</div>
    </aside>
  </main>
</body>
</html>
